#:schema https://mise.jdx.dev/schema/mise.json

[vars]
registry = "{{ get_env(name='REGISTRY', default='ghcr.io/kasuboski/opencode-container') }}"
image_name = "{{ get_env(name='IMAGE_NAME', default='opencode') }}"
tag = "{{ get_env(name='TAG', default='latest') }}"

opencode_version = "{{ exec(command='yq e \".opencode\" versions.yml') | trim }}"
bun_version = "{{ exec(command='yq e \".bun\" versions.yml') | trim }}"
uv_version = "{{ exec(command='yq e \".uv\" versions.yml') | trim }}"
mise_version = "{{ exec(command='yq e \".mise\" versions.yml') | trim }}"

[task_config]
dir = "{{ config_root }}"

[tasks.build]
description = "Build multi-arch image and push to registry"
run = '''
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  --build-arg OPENCODE_VERSION={{ vars.opencode_version }} \
  --build-arg BUN_VERSION={{ vars.bun_version }} \
  --build-arg UV_VERSION={{ vars.uv_version }} \
  --build-arg MISE_VERSION={{ vars.mise_version }} \
  --tag {{ vars.registry }}/{{ vars.image_name }}:{{ vars.tag }} \
  --push .
'''

[tasks."build-amd64"]
description = "Build amd64 image locally"
run = '''
docker build \
  --platform linux/amd64 \
  --build-arg OPENCODE_VERSION={{ vars.opencode_version }} \
  --build-arg BUN_VERSION={{ vars.bun_version }} \
  --build-arg UV_VERSION={{ vars.uv_version }} \
  --build-arg MISE_VERSION={{ vars.mise_version }} \
  --tag {{ vars.image_name }}:{{ vars.tag }}-amd64 \
  .
'''

[tasks."build-arm64"]
description = "Build arm64 image locally"
run = '''
docker build \
  --platform linux/arm64 \
  --build-arg OPENCODE_VERSION={{ vars.opencode_version }} \
  --build-arg BUN_VERSION={{ vars.bun_version }} \
  --build-arg UV_VERSION={{ vars.uv_version }} \
  --build-arg MISE_VERSION={{ vars.mise_version }} \
  --tag {{ vars.image_name }}:{{ vars.tag }}-arm64 \
  .
'''

[tasks.push]
description = "Push image to registry"
run = "docker push {{ vars.registry }}/{{ vars.image_name }}:{{ vars.tag }}"

[tasks."test-structure"]
description = "Run container structure tests against local amd64 image"
run = '''
container-structure-test test \
  --image {{ vars.image_name }}:{{ vars.tag }}-amd64 \
  --config container-structure-test.yaml
'''

[tasks."test-structure-arm64"]
description = "Run container structure tests against local arm64 image"
run = '''
container-structure-test test \
  --image {{ vars.image_name }}:{{ vars.tag }}-arm64 \
  --config container-structure-test.yaml
'''

[tasks."test-and-build"]
description = "Build amd64 image and run structure tests"
depends = ["build-amd64", "test-structure"]
